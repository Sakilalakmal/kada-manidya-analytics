services:
  analytics_sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: analytics_sqlserver
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: "YourStrong!Passw0rd"
    ports:
      - "${ANALYTICS_SQL_HOST_PORT:-15433}:1433"
    volumes:
      - analytics_sqlserver_data:/var/opt/mssql
    networks:
      - kada_net
    restart: unless-stopped

  analytics_tracker:
    build: .
    container_name: analytics_tracker
    command:
      - sh
      - -lc
      - |
        exec python -m src.tracking.run_server --host 0.0.0.0 --port 9000
    ports:
      - "9000:9000"
    environment:
      # Connect to CORE RabbitMQ (from infra compose)
      RABBITMQ_URL: "amqp://guest:guest@kada_rabbitmq:5672/"
      RABBITMQ_EXCHANGE: "domain.events"
      RABBITMQ_EXCHANGE_TYPE: "topic"
      # Optional SQL connectivity for /health (analytics warehouse)
      DB_HOST: "analytics_sqlserver"
      DB_PORT: "1433"
      DB_USER: "sa"
      DB_PASSWORD: "YourStrong!Passw0rd"
      DB_NAME: "kada_mandiya_analytics"
      DB_DRIVER: "ODBC Driver 18 for SQL Server"
      DB_TRUST_CERT: "true"
      TRACKING_API_HOST: "0.0.0.0"
      TRACKING_API_PORT: "9000"
      TRACKING_CORS_ALLOW_ORIGINS: "http://localhost:3000,http://127.0.0.1:3000"
    depends_on:
      - analytics_sqlserver
    networks:
      - kada_net
    restart: unless-stopped

  analytics_consumer:
    build: .
    container_name: analytics_consumer
    command:
      - sh
      - -lc
      - |
        i=0
        until python -m src.scripts.test_db_connection; do
          i=$$((i+1))
          if [ "$$i" -ge 60 ]; then
            echo "SQL Server not ready after retries; exiting."
            exit 1
          fi
          echo "Waiting for SQL Server..."
          sleep 2
        done
        python -m src.etl.01_create_warehouse
        exec python -m src.scripts.run_consumer
    environment:
      # Connect to CORE RabbitMQ (from core compose)
      RABBITMQ_URL: "amqp://guest:guest@kada_rabbitmq:5672/"
      RABBITMQ_EXCHANGE: "domain.events"
      RABBITMQ_EXCHANGE_TYPE: "topic"
      RABBITMQ_QUEUE: "analytics.business.events"
      RABBITMQ_ROUTING_KEYS: "ui.page_view,ui.click,ui.add_to_cart,ui.begin_checkout,order.created,order.paid,payment.succeeded"
      ANALYTICS_CONSUMER_ENABLED: "yes"
      # Connect to ANALYTICS SQL Server (this compose)
      DB_HOST: "analytics_sqlserver"
      DB_PORT: "1433"
      DB_USER: "sa"
      DB_PASSWORD: "YourStrong!Passw0rd"
      DB_NAME: "kada_mandiya_analytics"
      DB_DRIVER: "ODBC Driver 18 for SQL Server"
      DB_TRUST_CERT: "true"
      CONSUMER_HEALTH_ENABLED: "yes"
      CONSUMER_HEALTH_HOST: "0.0.0.0"
      CONSUMER_HEALTH_PORT: "9100"
    ports:
      - "9100:9100"
    depends_on:
      - analytics_sqlserver
    networks:
      - kada_net
    restart: unless-stopped

  analytics_etl:
    build: .
    container_name: analytics_etl
    # Watch mode keeps silver/gold fresh automatically (no manual ETL)
    command:
      - sh
      - -lc
      - |
        i=0
        until python -m src.scripts.test_db_connection; do
          i=$$((i+1))
          if [ "$$i" -ge 60 ]; then
            echo "SQL Server not ready after retries; exiting."
            exit 1
          fi
          echo "Waiting for SQL Server..."
          sleep 2
        done
        python -m src.etl.01_create_warehouse
        exec python -m src.jobs.runner --watch --interval-seconds 60 --window-days 30 --no-seed
    environment:
      DB_HOST: "analytics_sqlserver"
      DB_PORT: "1433"
      DB_USER: "sa"
      DB_PASSWORD: "YourStrong!Passw0rd"
      DB_NAME: "kada_mandiya_analytics"
      DB_DRIVER: "ODBC Driver 18 for SQL Server"
      DB_TRUST_CERT: "true"
    depends_on:
      - analytics_sqlserver
    networks:
      - kada_net
    restart: unless-stopped

  analytics_dashboard:
    build: .
    container_name: analytics_dashboard
    command:
      - sh
      - -lc
      - |
        i=0
        until python -m src.scripts.test_db_connection; do
          i=$$((i+1))
          if [ "$$i" -ge 60 ]; then
            echo "SQL Server not ready after retries; exiting."
            exit 1
          fi
          echo "Waiting for SQL Server..."
          sleep 2
        done
        python -m src.etl.01_create_warehouse
        exec streamlit run dashboards/app.py --server.address=0.0.0.0 --server.port=8501
    ports:
      - "8501:8501"
    environment:
      DB_HOST: "analytics_sqlserver"
      DB_PORT: "1433"
      DB_USER: "sa"
      DB_PASSWORD: "YourStrong!Passw0rd"
      DB_NAME: "kada_mandiya_analytics"
      DB_DRIVER: "ODBC Driver 18 for SQL Server"
      DB_TRUST_CERT: "true"
    depends_on:
      - analytics_sqlserver
    networks:
      - kada_net
    restart: unless-stopped

volumes:
  analytics_sqlserver_data:

networks:
  kada_net:
    external: true
    name: kada_net
